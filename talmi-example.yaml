audit:
  enabled: true
  type: jsonl
  path: talmi-audit.jsonl

issuers:
  - name: github-actions
    type: static
    token_map:
      "this-is-a-super-secret-token":
        repository: my-org/my-repo

  - name: landscape-poc-concourse
    type: oidc
    issuer_url: "https://k8s-concourse.poc.landscape.acme.com"
    client_id: "talmi-example-audience" # audience

providers:
  - name: talmi
    type: talmi-jwt

  - name: github
    type: stub # log & return dummy token

  - name: daniel-org
    type: github-app
    app_id: 1126
    private_key_path: "./talmi-dev-token-adapter.2025-12-08.private-key.pem"
    server: "https://github.acme.com/api/v3/"

rules:
  - name: allow-concourse-to-access-github
    description: "Allow Concourse CI to access GitHub repo"
    match:
      issuer: landscape-poc-concourse
      conditions:
        - key: sub
          operator: equals
          value: "my-team/my-pipeline//my-job"
    grant:
      provider: daniel-org
      permissions:
        contents: "write"
      config:
        owner: SAPlings
        repositories:
          - ASR

  - name: allow-concourse-to-create-talmi-jwt # ONLY FOR DEBUGGING, DON'T DO THIS!
    description: Allow any Concourse OIDC token to get a Talmi JWT
    match:
      issuer: landscape-poc-concourse
    grant:
      provider: talmi
      config:
        roles: [ "admin" ]

  - name: allow-github-actions
    description: "Allow source repo CI to access target repo"
    match:
      issuer: github-actions
      expr: >-
        principal.Attributes["repository"] == "my-org/my-repo"
    grant:
      provider: github
      resource:
        type: "github_repo"
        id: "my-org/target-repo"
      permissions:
        contents: "write"
